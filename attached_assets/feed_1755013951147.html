<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Feed - Art Connect</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <a href="../index.html" class="nav-brand">Art Connect</a>
                <ul class="nav-menu">
                    <li><a href="../index.html">Home</a></li>
                    <li><a href="feed.html" class="active">Art Feed</a></li>
                    <li><a href="upload.html">Upload Art</a></li>
                    <li><a href="about.html">About</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="art-feed">
            <h1>Art Feed</h1>
            <div class="art-grid" id="artGrid">
                <!-- Art posts will be dynamically loaded here -->
            </div>

            <!-- Loading spinner -->
            <div id="loadingSpinner" class="loading-spinner hidden">
                <div class="spinner"></div>
            </div>

            <!-- Error message -->
            <div id="errorMessage" class="error-message hidden">
                <p>Sorry, there was an error loading the feed. Please try again later.</p>
            </div>

            <!-- No posts message -->
            <div id="noPostsMessage" class="no-posts-message hidden">
                <p>No art posts yet. Be the first to share your artwork!</p>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://ywfoxtfqywxxwjlocxpg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3Zm94dGZxeXd4eHdqbG9jeHBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzM0MDcsImV4cCI6MjA3MDU0OTQwN30.OjVWNkP_rdmsw7k0bWH9l4Z3U68Ch-d5AeNE9V6H09k';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Check if user is logged in
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) {
            console.error('Error checking auth:', error);
            window.location.href = '../auth.html';
            return;
        }

        if (!user) {
            window.location.href = '../auth.html';
            return;
        }

        // Get user profile
        const { data: profile, error: profileError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

        if (profileError) {
            console.error('Error fetching profile:', profileError);
            // Create profile if it doesn't exist
            const { error: createError } = await supabase
                .from('profiles')
                .insert([
                    {
                        id: user.id,
                        display_name: user.user_metadata?.display_name || user.email.split('@')[0],
                        email: user.email,
                        avatar_url: null,
                        created_at: new Date().toISOString()
                    }
                ]);

            if (createError) {
                console.error('Error creating profile:', createError);
                window.location.href = '../auth.html';
                return;
            }
        }

        // Show loading spinner
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('noPostsMessage').classList.add('hidden');
        }

        // Hide loading spinner
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Show error message
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        // Load art posts
        async function loadArtPosts() {
            showLoading();
            
            try {
                const { data, error } = await supabase
                    .from('art_posts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const artGrid = document.getElementById('artGrid');
                artGrid.innerHTML = ''; // Clear existing posts

                if (data.length === 0) {
                    document.getElementById('noPostsMessage').classList.remove('hidden');
                } else {
                    data.forEach(post => {
                        const postElement = createPostElement(post);
                        artGrid.appendChild(postElement);
                    });
                }
            } catch (error) {
                console.error('Error loading posts:', error);
                showError('Failed to load posts. Please try again.');
            } finally {
                hideLoading();
            }
        }

        // Create post element
        function createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'art-post';
            postElement.innerHTML = `
                <img src="${post.image_url}" alt="${post.title}" class="art-image">
                <div class="post-info">
                    <h3>${post.title}</h3>
                    <p>${post.description}</p>
                    <p>By ${post.artist_name}</p>
                    <div class="post-actions">
                        <button onclick="likePost('${post.id}')">
                            <i class="fas fa-heart"></i>
                            <span class="like-count">${post.like_count || 0}</span>
                        </button>
                        <button onclick="commentPost('${post.id}')">
                            <i class="fas fa-comment"></i>
                        </button>
                        <span class="post-date">${formatDate(post.created_at)}</span>
                    </div>
                    <div class="comment-section" style="display: none;">
                        <input type="text" class="comment-input" placeholder="Add a comment...">
                        <div class="comments-list"></div>
                    </div>
                </div>
            `;
            return postElement;
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Like post
        async function likePost(postId) {
            try {
                // Check if user has already liked this post
                const { data: existingLike, error: likeError } = await supabase
                    .from('likes')
                    .select('*')
                    .eq('post_id', postId)
                    .eq('user_id', user.id)
                    .single();

                if (likeError && likeError.code !== 'PGRST116') {
                    throw likeError;
                }

                if (existingLike) {
                    // Unlike the post
                    const { error: deleteError } = await supabase
                        .from('likes')
                        .delete()
                        .eq('post_id', postId)
                        .eq('user_id', user.id);

                    if (deleteError) throw deleteError;
                    
                    const { error: updateError } = await supabase
                        .from('art_posts')
                        .update({
                            like_count: supabase.fn.dec(1)
                        })
                        .eq('id', postId);

                    if (updateError) throw updateError;
                } else {
                    // Like the post
                    const { error: insertError } = await supabase
                        .from('likes')
                        .insert({
                            post_id: postId,
                            user_id: user.id,
                            created_at: new Date().toISOString()
                        });

                    if (insertError) throw insertError;

                    const { error: updateError } = await supabase
                        .from('art_posts')
                        .update({
                            like_count: supabase.fn.inc(1)
                        })
                        .eq('id', postId);

                    if (updateError) throw updateError;
                }

                loadArtPosts(); // Refresh the feed
            } catch (error) {
                console.error('Error liking/unliking post:', error);
                alert('Failed to like/unlike post. Please try again.');
            }
        }
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', loadArtPosts);
</script>
</body>
</html>
